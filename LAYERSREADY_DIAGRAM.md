# ğŸ¨ Architecture layersReadyRef - Diagramme Visuel

## ğŸ”„ Flow complet: Style change (Night â†’ Satellite)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    USER CLIQUE "SATELLITE"                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MAPBOX INTERNAL: Detruit tout                                       â”‚
â”‚  - removeAllLayers()                                                â”‚
â”‚  - removeAllSources()                                               â”‚
â”‚  - style.load event fires                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ EFFECT A (INIT): handleStyleLoad()                                  â”‚
â”‚                                                                     â”‚
â”‚  1. layersReadyRef = false  â—„â”€â”€â”€ BLOCK DATA + TOGGLE effects      â”‚
â”‚                                                                     â”‚
â”‚  2. initializeSpotSources()                                         â”‚
â”‚     â”‚                                                               â”‚
â”‚     â”œâ”€â–º if (!isStyleLoaded()) return âœ…                            â”‚
â”‚     â”œâ”€â–º addSource(CLUSTER) âœ…                                      â”‚
â”‚     â”œâ”€â–º addSource(PLAIN) âœ…                                        â”‚
â”‚     â”œâ”€â–º addLayer(cluster-circles) âœ…                               â”‚
â”‚     â”œâ”€â–º addLayer(cluster-count) âœ…                                 â”‚
â”‚     â”œâ”€â–º setupGhostEchoLayers() âœ…                                  â”‚
â”‚     â””â”€â–º setLayoutProperty(visibility) based on clusteringEnabled âœ…â”‚
â”‚                                                                     â”‚
â”‚  3. layersReadyRef = true  â—„â”€â”€â”€ UNBLOCK DATA + TOGGLE effects     â”‚
â”‚                                                                     â”‚
â”‚  ğŸ“‹ Log: "[INIT] âœ… Layers ready, visibility set to: CLUSTER/PLAIN"â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â–¼                   â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ EFFECT B (DATA)         â”‚  â”‚ EFFECT C (TOGGLE)       â”‚
    â”‚                         â”‚  â”‚                         â”‚
    â”‚ if (!layersReadyRef)    â”‚  â”‚ if (!layersReadyRef)    â”‚
    â”‚   return âœ… NOW FALSE   â”‚  â”‚   return âœ… NOW FALSE   â”‚
    â”‚                         â”‚  â”‚                         â”‚
    â”‚ activeSource.setData()  â”‚  â”‚ setLayoutProperty()     â”‚
    â”‚                         â”‚  â”‚                         â”‚
    â”‚ ğŸ“‹ "[DATA] âœ… Updated"  â”‚  â”‚ ğŸ“‹ "[TOGGLE] âœ… Vis.."  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ MAP RENDER: Pins/clusters       â”‚
            â”‚ visibles sur Satellite style âœ… â”‚
            â”‚                                 â”‚
            â”‚ â±ï¸ Total: ~50-100ms             â”‚
            â”‚ ğŸ”„ Refresh page: âŒ NON REQUIS  â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ§© Protection layers (Defense in depth)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         USER ACTION                            â”‚
â”‚               (Toggle clustering / Style change)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LAYER 1: mapInstance check                                    â”‚
â”‚  â”œâ”€â–º if (!mapInstance) return âœ…                              â”‚
â”‚  â””â”€â–º Prevents operations on unmounted component               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LAYER 2: layersReadyRef check (DATA + TOGGLE only)            â”‚
â”‚  â”œâ”€â–º if (!layersReadyRef.current) return âœ…                   â”‚
â”‚  â””â”€â–º Prevents operations before structural init complete      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LAYER 3: isStyleLoaded() check (INIT only)                    â”‚
â”‚  â”œâ”€â–º if (!mapInstance.isStyleLoaded()) return âœ…              â”‚
â”‚  â””â”€â–º Prevents addSource/addLayer before style ready           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LAYER 4: getSource() / getLayer() guards                      â”‚
â”‚  â”œâ”€â–º if (!getSource(id)) addSource(...) âœ…                    â”‚
â”‚  â”œâ”€â–º if (!getLayer(id)) addLayer(...) âœ…                      â”‚
â”‚  â”œâ”€â–º if (getLayer(id)) setLayoutProperty(...) âœ…              â”‚
â”‚  â””â”€â–º Prevents duplicate errors + operations on missing objectsâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                    âœ… SAFE OPERATION
```

---

## ğŸ“Š State transitions

### **INIT effect (EFFECT A)**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    EFFECT A STATE MACHINE                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[IDLE]
  â”‚
  â”‚ mount or style.load
  â–¼
[INITIALIZING]  â—„â”€â”€â”€ layersReadyRef = false
  â”‚
  â”‚ addSource() âœ…
  â”‚ addLayer() âœ…
  â”‚ setLayoutProperty(visibility) âœ…
  â–¼
[READY]  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ layersReadyRef = true
  â”‚
  â”‚ (stay in READY until next style.load)
  â”‚
  â”‚ style.load event
  â–¼
[INITIALIZING]  â—„â”€â”€â”€ layersReadyRef = false (reset)
  â”‚
  â”‚ ... re-init ...
  â–¼
[READY]  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ layersReadyRef = true
```

---

### **DATA effect (EFFECT B)**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    EFFECT B STATE MACHINE                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[IDLE]
  â”‚
  â”‚ spotFeatures change OR clusteringEnabled toggle
  â–¼
[CHECK READY]
  â”‚
  â”œâ”€â–º if (!layersReadyRef.current) â”€â”€â–º [WAIT] â”€â–º return
  â”‚
  â””â”€â–º if (layersReadyRef.current)
      â”‚
      â–¼
    [DETERMINE ACTIVE SOURCE]
      â”‚
      â”œâ”€â–º clusteringEnabled = true  â”€â”€â–º activeSourceId = CLUSTER
      â””â”€â–º clusteringEnabled = false â”€â”€â–º activeSourceId = PLAIN
      â”‚
      â–¼
    [UPDATE DATA]
      â”‚
      â””â”€â–º activeSource.setData(featureCollection) âœ…
      â”‚
      â–¼
    [COMPLETE]
```

---

### **TOGGLE effect (EFFECT C)**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    EFFECT C STATE MACHINE                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[IDLE]
  â”‚
  â”‚ clusteringEnabled toggle
  â–¼
[CHECK READY]
  â”‚
  â”œâ”€â–º if (!layersReadyRef.current) â”€â”€â–º [WAIT] â”€â–º return
  â”‚
  â””â”€â–º if (layersReadyRef.current)
      â”‚
      â–¼
    [COMPUTE VISIBILITY]
      â”‚
      â”œâ”€â–º clusteringEnabled = true
      â”‚   â”œâ”€â–º clusterVisibility = "visible"
      â”‚   â””â”€â–º plainVisibility = "none"
      â”‚
      â””â”€â–º clusteringEnabled = false
          â”œâ”€â–º clusterVisibility = "none"
          â””â”€â–º plainVisibility = "visible"
      â”‚
      â–¼
    [APPLY VISIBILITY]
      â”‚
      â”œâ”€â–º CLUSTER_LAYER_IDS.forEach(...)
      â”‚   â””â”€â–º if (getLayer()) setLayoutProperty("visibility") âœ…
      â”‚
      â””â”€â–º PLAIN_LAYER_IDS.forEach(...)
          â””â”€â–º if (getLayer()) setLayoutProperty("visibility") âœ…
      â”‚
      â–¼
    [COMPLETE]
```

---

## ğŸ¯ Synchronisation timeline

```
TIME  â”‚ EFFECT A (INIT)         â”‚ EFFECT B (DATA)            â”‚ EFFECT C (TOGGLE)
â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
0ms   â”‚ handleStyleLoad()       â”‚ (waiting)                  â”‚ (waiting)
      â”‚ layersReadyRef = false  â”‚ if (!ready) return â¸ï¸      â”‚ if (!ready) return â¸ï¸
      â”‚                         â”‚                            â”‚
10ms  â”‚ addSource(CLUSTER) âœ…   â”‚ (waiting)                  â”‚ (waiting)
      â”‚                         â”‚                            â”‚
15ms  â”‚ addSource(PLAIN) âœ…     â”‚ (waiting)                  â”‚ (waiting)
      â”‚                         â”‚                            â”‚
20ms  â”‚ addLayer(circles) âœ…    â”‚ (waiting)                  â”‚ (waiting)
      â”‚                         â”‚                            â”‚
25ms  â”‚ addLayer(count) âœ…      â”‚ (waiting)                  â”‚ (waiting)
      â”‚                         â”‚                            â”‚
30ms  â”‚ setupGhostEchoLayers()  â”‚ (waiting)                  â”‚ (waiting)
      â”‚ âœ…                      â”‚                            â”‚
      â”‚                         â”‚                            â”‚
35ms  â”‚ setLayoutProperty(      â”‚ (waiting)                  â”‚ (waiting)
      â”‚   visibility) âœ…        â”‚                            â”‚
      â”‚                         â”‚                            â”‚
40ms  â”‚ layersReadyRef = true   â”‚ âœ… UNBLOCKED!              â”‚ âœ… UNBLOCKED!
      â”‚ âœ… COMPLETE             â”‚                            â”‚
      â”‚                         â”‚                            â”‚
45ms  â”‚ (idle)                  â”‚ setData(features) âœ…       â”‚ (waiting)
      â”‚                         â”‚                            â”‚
50ms  â”‚ (idle)                  â”‚ âœ… COMPLETE                â”‚ setLayoutProperty() âœ…
      â”‚                         â”‚                            â”‚
55ms  â”‚ (idle)                  â”‚ (idle)                     â”‚ âœ… COMPLETE
      â”‚                         â”‚                            â”‚
60ms  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º MAP RENDER âœ… â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      â”‚                         Pins/clusters visibles
```

---

## ğŸ” Guard combinations

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OPERATION: addSource()                                              â”‚
â”‚                                                                     â”‚
â”‚ Guards applied:                                                     â”‚
â”‚  1. âœ… if (!mapInstance) return                                    â”‚
â”‚  2. âœ… if (!isStyleLoaded()) return                                â”‚
â”‚  3. âœ… if (!getSource(id)) { addSource(...) }                      â”‚
â”‚                                                                     â”‚
â”‚ Result: Safe against:                                               â”‚
â”‚  - Unmounted component                                              â”‚
â”‚  - Style not loaded                                                 â”‚
â”‚  - Duplicate source                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OPERATION: addLayer()                                               â”‚
â”‚                                                                     â”‚
â”‚ Guards applied:                                                     â”‚
â”‚  1. âœ… if (!mapInstance) return                                    â”‚
â”‚  2. âœ… if (!isStyleLoaded()) return                                â”‚
â”‚  3. âœ… if (!getLayer(id)) { addLayer(...) }                        â”‚
â”‚                                                                     â”‚
â”‚ Result: Safe against:                                               â”‚
â”‚  - Unmounted component                                              â”‚
â”‚  - Style not loaded                                                 â”‚
â”‚  - Duplicate layer                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OPERATION: setData()                                                â”‚
â”‚                                                                     â”‚
â”‚ Guards applied:                                                     â”‚
â”‚  1. âœ… if (!mapInstance) return                                    â”‚
â”‚  2. âœ… if (!layersReadyRef.current) return                         â”‚
â”‚  3. âœ… if (activeSource) { setData(...) }                          â”‚
â”‚                                                                     â”‚
â”‚ Result: Safe against:                                               â”‚
â”‚  - Unmounted component                                              â”‚
â”‚  - Sources not created yet                                          â”‚
â”‚  - Source not found                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OPERATION: setLayoutProperty()                                      â”‚
â”‚                                                                     â”‚
â”‚ Guards applied:                                                     â”‚
â”‚  1. âœ… if (!mapInstance) return                                    â”‚
â”‚  2. âœ… if (!layersReadyRef.current) return                         â”‚
â”‚  3. âœ… if (getLayer(id)) { setLayoutProperty(...) }                â”‚
â”‚                                                                     â”‚
â”‚ Result: Safe against:                                               â”‚
â”‚  - Unmounted component                                              â”‚
â”‚  - Layers not created yet                                           â”‚
â”‚  - Layer not found                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ˆ Performance impact

```
OPERATION              â”‚ BEFORE (no layersReadyRef) â”‚ AFTER (with layersReadyRef)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Style change (total)   â”‚ ~100ms + warnings          â”‚ ~50-100ms, no warnings âœ…
  - INIT (structural)  â”‚ ~40ms                      â”‚ ~40ms (unchanged)
  - DATA (setData)     â”‚ âš ï¸ May fail (no guard)     â”‚ ~10ms âœ… Safe
  - TOGGLE (visibility)â”‚ âš ï¸ May crash (no guard)    â”‚ ~5ms âœ… Safe
                       â”‚                            â”‚
Toggle clustering      â”‚ ~15ms                      â”‚ ~15ms (unchanged) âœ…
  - No re-init         â”‚ âœ…                         â”‚ âœ…
  - Guards prevent     â”‚ âœ…                         â”‚ âœ…
                       â”‚                            â”‚
Console warnings       â”‚ âš ï¸ 2-3 per style change    â”‚ âŒ ZERO âœ…
FPS drop               â”‚ ~55 FPS (transient)        â”‚ ~55 FPS (transient, same)
Layer recreation       â”‚ âŒ NO (already fixed)      â”‚ âŒ NO (maintained) âœ…
```

**Overhead:** `if (!layersReadyRef.current) return` â‰ˆ **0.01ms** (nÃ©gligeable)

---

## ğŸ¨ Visibility state diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       VISIBILITY STATES                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                      clusteringEnabled = false
                      (pins mode)
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                                     â”‚
    â”‚  CLUSTER LAYERS: visibility = "none" âŒ            â”‚
    â”‚  PLAIN LAYERS:   visibility = "visible" âœ…         â”‚
    â”‚                                                     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚                 â–²
                      â”‚ Toggle ON       â”‚ Toggle OFF
                      â–¼                 â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                                     â”‚
    â”‚  CLUSTER LAYERS: visibility = "visible" âœ…         â”‚
    â”‚  PLAIN LAYERS:   visibility = "none" âŒ            â”‚
    â”‚                                                     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      clusteringEnabled = true
                      (cluster mode)

Note: Style change preserves current clusteringEnabled state âœ…
```

---

## ğŸ” Error recovery

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SCENARIO: Style change interrupted (user spam clicks styles)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

T0: Click "Satellite"
    â†’ layersReadyRef = false
    â†’ addSource(CLUSTER) starts...

T1: Click "Night" (INTERRUPT)
    â†’ layersReadyRef = false (already false)
    â†’ Previous init abandoned
    â†’ NEW init starts:
      - addSource(CLUSTER) [Mapbox internal handles cleanup]
      - addLayer(...) âœ…

T2: NEW init completes
    â†’ layersReadyRef = true âœ…

Result: âœ… Robust, last style wins, no crash

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SCENARIO: DATA effect triggers during INIT                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

T0: spotFeatures updated (fetch completes)
    â†’ EFFECT B (DATA) triggers

T1: Check layersReadyRef
    â†’ if (!layersReadyRef.current) return â¸ï¸
    â†’ Skip setData (sources not ready yet)

T2: INIT completes
    â†’ layersReadyRef = true

T3: EFFECT B re-triggers (clusteringEnabled in deps)
    â†’ layersReadyRef.current âœ… true
    â†’ setData(features) âœ…

Result: âœ… No error, data applied when ready
```

---

## ğŸ“š Quick reference

| Symbol | Meaning |
|--------|---------|
| âœ… | Operation safe / Guard passed |
| âŒ | Blocked / Not visible |
| â¸ï¸ | Waiting (deferred) |
| ğŸ”„ | Re-initialization |
| âš ï¸ | Warning (should not happen) |
| ğŸ“‹ | Console log |

---

**Architecture complÃ¨te:** `MAPBOX_LAYERSREADY_ARCHITECTURE.md`  
**Tests:** `TEST_STYLE_CHANGES.md`  
**RÃ©sumÃ©:** `MAPBOX_IMPLEMENTATION_SUMMARY.md`
